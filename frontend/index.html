<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Records Blockchain System</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Medical Records Access System</h1>
            <p class="subtitle">Blockchain-based Medical Records Management on Sepolia</p>
        </header>

        <!-- Connection Section -->
        <div class="card connection-card">
            <h2>Wallet Connection</h2>
            <div id="ethers-status" style="margin-bottom: 10px; padding: 10px; border-radius: 6px; background: #fff3cd; display: none;">
                <strong>Library Status:</strong> <span id="ethers-status-text">Loading ethers.js...</span>
            </div>
            <div id="metamask-detection" style="margin-bottom: 15px; padding: 10px; border-radius: 6px; background: #fff3cd; display: none;">
                <strong>MetaMask Status:</strong> <span id="metamask-status">Checking...</span>
            </div>
            <div class="connection-info">
                <div class="info-item">
                    <strong>Network:</strong> <span id="network-status">Not Connected</span>
                    <button id="switch-network" class="btn btn-primary" style="display: none; margin-left: 10px; padding: 8px 16px; font-size: 0.9rem;">Switch to Sepolia</button>
                </div>
                <div class="info-item">
                    <strong>Account:</strong> <span id="account-address">Not Connected</span>
                </div>
                <div class="info-item">
                    <strong>Contract:</strong> <input type="text" id="contract-address" placeholder="Enter contract address">
                    <button id="connect-wallet" class="btn btn-primary">Connect Wallet</button>
                </div>
            </div>
        </div>

        <!-- Role Selection -->
        <div class="card role-card">
            <h2>Select Your Role</h2>
            <div class="role-buttons">
                <button id="role-patient" class="btn btn-role active">Patient</button>
                <button id="role-doctor" class="btn btn-role">‚ÄçDoctor</button>
            </div>
        </div>

        <!-- Patient Section -->
        <div id="patient-section" class="card section-card">
            <h2>Patient Dashboard</h2>
            
            <!-- Upload Record -->
            <div class="function-card">
                <h3>Upload Medical Record</h3>
                <div class="form-group">
                    <label for="record-id">Record ID:</label>
                    <input type="text" id="record-id" placeholder="e.g., REC001">
                </div>
                <div class="form-group">
                    <label for="record-file">Medical Record File:</label>
                    <input type="file" id="record-file" accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png">
                    <small>Upload your medical record document (PDF, DOC, TXT, or Image). File will be stored securely in cloud storage.</small>
                </div>
                <div id="file-info" style="display: none; padding: 10px; background: #f0f0f0; border-radius: 6px; margin-bottom: 10px;">
                    <strong>Selected File:</strong> <span id="file-name"></span><br>
                    <strong>Size:</strong> <span id="file-size"></span><br>
                    <strong>Hash:</strong> <span id="file-hash" style="font-family: monospace; font-size: 0.85rem;"></span>
                </div>
                <button id="upload-record" class="btn btn-action">Upload to Blockchain & Cloud</button>
                <div id="upload-result" style="margin-top: 15px;"></div>
            </div>

            <!-- Grant Access -->
            <div class="function-card">
                <h3>Grant Doctor Access</h3>
                <div class="form-group">
                    <label for="grant-record-id">Record ID:</label>
                    <input type="text" id="grant-record-id" placeholder="e.g., REC001">
                </div>
                <div class="form-group">
                    <label for="doctor-address">Doctor Address:</label>
                    <input type="text" id="doctor-address" placeholder="0x...">
                </div>
                <button id="grant-access" class="btn btn-action">Grant Access</button>
            </div>

            <!-- Revoke Access -->
            <div class="function-card">
                <h3>Revoke Doctor Access</h3>
                <div class="form-group">
                    <label for="revoke-record-id">Record ID:</label>
                    <input type="text" id="revoke-record-id" placeholder="e.g., REC001">
                </div>
                <div class="form-group">
                    <label for="revoke-doctor-address">Doctor Address:</label>
                    <input type="text" id="revoke-doctor-address" placeholder="0x...">
                </div>
                <button id="revoke-access" class="btn btn-action">Revoke Access</button>
            </div>

            <!-- View Record Info -->
            <div class="function-card">
                <h3>View Record Information</h3>
                <div class="form-group">
                    <label for="view-record-id">Record ID:</label>
                    <input type="text" id="view-record-id" placeholder="e.g., REC001">
                    <small>You can only view records that you own.</small>
                </div>
                <button id="view-record" class="btn btn-action">View Record</button>
                <div id="record-info" class="result-box"></div>
                <div id="record-file-display" style="margin-top: 15px; display: none;">
                    <h4 style="margin-bottom: 10px;">üìÅ Cloud Storage</h4>
                    <div id="cloud-file-info" style="padding: 15px; background: #e3f2fd; border-radius: 6px; border-left: 4px solid #2196f3;">
                        <div id="file-download-section"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Doctor Section -->
        <div id="doctor-section" class="card section-card" style="display: none;">
            <h2>Doctor Dashboard</h2>
            
            <!-- Check Access -->
            <div class="function-card">
                <h3>Check Access Permission</h3>
                <div class="form-group">
                    <label for="check-record-id">Record ID:</label>
                    <input type="text" id="check-record-id" placeholder="e.g., REC001">
                </div>
                <div class="form-group">
                    <label for="check-user-address">Your Address:</label>
                    <input type="text" id="check-user-address" placeholder="0x... or leave empty for current account">
                </div>
                <button id="check-access" class="btn btn-action">Check Access</button>
                <div id="access-result" class="result-box"></div>
            </div>

            <!-- View Record Info -->
            <div class="function-card">
                <h3>View Record Information</h3>
                <div class="form-group">
                    <label for="doctor-view-record-id">Record ID:</label>
                    <input type="text" id="doctor-view-record-id" placeholder="e.g., REC001">
                    <small>You can only view records where you have been granted access.</small>
                </div>
                <button id="doctor-view-record" class="btn btn-action">View Record</button>
                <div id="doctor-record-info" class="result-box"></div>
                <div id="doctor-file-display" style="margin-top: 15px; display: none;">
                    <h4 style="margin-bottom: 10px;">üìÅ Cloud Storage</h4>
                    <div id="doctor-cloud-file-info" style="padding: 15px; background: #e3f2fd; border-radius: 6px; border-left: 4px solid #2196f3;">
                        <div id="doctor-file-download-section"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transaction Status -->
        <div id="transaction-status" class="card status-card" style="display: none;">
            <h3>Transaction Status</h3>
            <div id="status-message"></div>
        </div>

        <!-- Event Log -->
        <div class="card event-card">
            <h2>Recent Events</h2>
            <div id="event-log" class="event-log">
                <p class="no-events">No events yet. Connect wallet and perform actions to see events here.</p>
            </div>
        </div>
    </div>

    <!-- Load ethers.js from CDN with fallback -->
    <script>
        // Load ethers.js with fallback
        function loadEthers() {
            const scripts = [
                'https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js',
                'https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js',
                'https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js'
            ];
            
            let currentScript = 0;
            
                function tryNext() {
                const ethersStatusEl = document.getElementById('ethers-status');
                const ethersStatusText = document.getElementById('ethers-status-text');
                
                if (currentScript >= scripts.length) {
                    console.error('Failed to load ethers.js from all CDNs');
                    if (ethersStatusEl) {
                        ethersStatusEl.style.background = '#f8d7da';
                        ethersStatusEl.style.display = 'block';
                    }
                    if (ethersStatusText) {
                        ethersStatusText.innerHTML = '‚ùå Failed to load ethers.js library. Check your internet connection or use a different CDN.';
                    }
                    return;
                }
                
                if (ethersStatusEl) {
                    ethersStatusEl.style.display = 'block';
                }
                if (ethersStatusText) {
                    ethersStatusText.textContent = `Loading ethers.js from CDN ${currentScript + 1}...`;
                }
                
                const script = document.createElement('script');
                script.src = scripts[currentScript];
                script.onerror = function() {
                    console.log('Failed to load from:', scripts[currentScript]);
                    currentScript++;
                    tryNext();
                };
                script.onload = function() {
                    console.log('Successfully loaded ethers.js from:', scripts[currentScript]);
                    // Wait a bit for ethers to be available
                    setTimeout(checkEthersLoaded, 100);
                };
                document.head.appendChild(script);
            }
            
            function checkEthersLoaded() {
                const ethersStatusEl = document.getElementById('ethers-status');
                const ethersStatusText = document.getElementById('ethers-status-text');
                
                if (typeof ethers !== 'undefined') {
                    console.log('ethers.js is ready!');
                    if (ethersStatusEl) {
                        ethersStatusEl.style.background = '#d4edda';
                        ethersStatusEl.style.display = 'block';
                    }
                    if (ethersStatusText) {
                        ethersStatusText.textContent = '‚úÖ ethers.js loaded successfully!';
                    }
                    // Start the app
                    if (typeof window.appReady === 'function') {
                        window.appReady();
                    }
                } else {
                    console.log('Waiting for ethers.js...');
                    setTimeout(checkEthersLoaded, 100);
                }
            }
            
            tryNext();
        }
        
        // Start loading when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadEthers);
        } else {
            loadEthers();
        }
    </script>
    <script src="app.js"></script>
</body>
</html>

